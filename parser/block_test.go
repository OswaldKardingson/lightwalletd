// Copyright (c) 2019-2020 The Zcash developers
// Copyright (c) 2019-2024 Pirate Chain developers
// Distributed under the MIT software license, see the accompanying
// file COPYING or https://www.opensource.org/licenses/mit-license.php .

package parser

import (
	"bytes"
	"encoding/hex"
	"encoding/json"
	"fmt"
	"io"
	"log"
	"testing"

	"github.com/pkg/errors"
	"github.com/stretchr/testify/assert"

	protobuf "google.golang.org/protobuf/proto"
)

func TestCompactBlocks(t *testing.T) {
	type compactTest struct {
		BlockHeight int    `json:"block"`
		BlockHash   string `json:"hash"`
		PrevHash    string `json:"prev"`
		Full        string `json:"full"`
		Compact     string `json:"compact"`
	}
	var compactTests []compactTest

	blockJSON, err := io.ReadFile("../testdata/compact_blocks.json")
	if err != nil {
		t.Fatal(err)
	}

	err = json.Unmarshal(blockJSON, &compactTests)
	if err != nil {
		t.Fatal(err)
	}

	for _, test := range compactTests {
		blockData, _ := hex.DecodeString(test.Full)
		block := NewBlock()
		blockData, err = block.ParseFromSlice(blockData)
		if err != nil {
			t.Error(errors.Wrap(err, fmt.Sprintf("parsing testnet block %d", test.BlockHeight)))
			continue
		}
		if len(blockData) > 0 {
			t.Error("Extra data remaining")
		}
		if block.GetHeight() != test.BlockHeight {
			t.Errorf("incorrect block height in testnet block %d", test.BlockHeight)
			continue
		}
		if hex.EncodeToString(block.GetDisplayHash()) != test.BlockHash {
			t.Errorf("incorrect block hash in testnet block %x", test.BlockHash)
			continue
		}
		if hex.EncodeToString(block.GetDisplayPrevHash()) != test.PrevHash {
			t.Errorf("incorrect block prevhash in testnet block %x", test.BlockHash)
			continue
		}
		if !bytes.Equal(block.GetPrevHash(), block.hdr.HashPrevBlock) {
			t.Error("block and block header prevhash don't match")
		}

		compact := block.ToCompact()
		marshaled, err := protobuf.Marshal(compact)
		if err != nil {
			t.Errorf("could not marshal compact testnet block %d", test.BlockHeight)
			continue
		}
		encodedCompact := hex.EncodeToString(marshaled)
		if encodedCompact != test.Compact {
			t.Errorf("wrong data for compact testnet block %d\nhave: %s\nwant: %s\n", test.BlockHeight, encodedCompact, test.Compact)
			break
		}
	}
}

// New tests for MerkleFrontier integration

func getValidBlockData() []byte {
	// Mock valid block data 
	// pirate-cli getblock 000000004af2561c80453ae05b51c259dff5e313609ef6a1a76e6c661a0874b0 0
	return []byte{
		/* 0400000098ed096437560c6f7c9d228c279a6c316b705e8abdff1ba9ad3808930000000013752f2e5e998b6c0b6856fe2413b216aa15406c42e560ba8e9222d4d73b0a834f0bad5158b983d581f2b256aacf47af79379ea6f2632e5e5e314b1a5ec3aa6bf1f5546756b6011d3fffabee00000000000000000000000000002d0000000000000000008018e53afd40050099fe94531276bcc85650b264bd49f1c0db330b4a2240824c2434ed5dc30468f37ffd86f6521f53fe5d3a11bb774b5a2367f810b65d8bfc9eaa1ad9f6f3174170edb08b52b4ff1cfb46201154ec32bdc4beb67d08b81cf157eca1699633a27235eb9b1257551f916c381a7f2d91a3f57f6ba88d41a0fff7a7941e7ea57511ce639cb187c5d4cf20baf87b5fcd72cd671defef342c82a33d5a2b2135b707aefac7457f479f9b2868034cbb3577854bbf2555e1ed2de71da8fcb80b87d11af6dad7dd8c7b36dc475abaf9ee5b8b10b01e2fb60cc1e4f6fe52245f744fb20c7e62f2ea6d0a93fa00235459bfead94692d25c7261fc72a538a171ddd89311e2f0bf21a2f1fbff59024b1abf5dd69ad8f82aa53e9d7a99cab110bdb5daf54174481e1662aab5684812b49c1f31286365d64d213178350712325df41cf951a13d018e211b21b79095d32163c38daa46d785e400d5362a1353daf73b3443b1ce7c0981483677d52b2fcfe1d27cddb76b515833d1452afe4d57b431433e0150cd267b1745aac469a02832e7612016c95db2190c3ec38c7365dcab3cd11282d8d9dd6a774ab4a86207febd11ef048b659780336e3b5a8e2aa2391f80d12dfd5326fa5e9291d09f92ffd57e4a5d2656d0e8cc538ba3f5859b1b6ffd024752d8f21dc9d716bf296f6f9965c1e99fbd6f831cc7423cdb34773902dc1aa604012a15a7c8a4d9290b0360387f56f562d5fe3a5f0ba876e558ec655ffb3c884a56caf49e2e44577997210fbb3017ccb445b5f7431c95f2986b260fdd335526ace66fddcb09332dd102e6c0e1139b635f7caba10895d862a446fef5719172b890c15af648a0b54e5215ddf590eba09735902a24e1306baa9d958df0be6c12bdb3a995df497b2f507362e91ec4ddd26798e56e1f168b6c6a92b5c1ede74387f467c1150eeb145e6c0140bbc39f6eb7597971a074a32c3110e9c9a88eab0e274b6c8e978e935936656f343fd6ba4d75d5a59d0256464fa27424b5d69e8074dae440284161393de60408d1c37d8636cd06d9d2311adb47994fdcd6116109d56dfc4873c41db0a150e24ee248e14e0a37086d3238dde4af944ff8d558a9378f6f6f5e548ab7100512c60ac611679419b8b5d2ad80de59f620ef51113f346e83944d4f92992fd8b39685315a81993a14210106f4a308e6533685910ba870387586b62e289861324839646acff6010dc5ad37931e4878634b86fbd6b11dd8d7a61cd82e38e2ee5a8315da3f86a6ab5d3a063ca6cd2cda24e901912aa40a487e2bea5f5d5c4cf707c2871ac9462fef14d0b15c97e5fcf8f2f34d7a5117ac338a290933331666a57d7e6508d65a13de30b215238ab0378583bb1fab317664e47cbd55339de6bf24a152802962fb1180b88534a1df764e4f823a4d2009c4c75faa1b6cf583321139675520555ed89bd6020bac5dd632c62ec9029bb3fc8ffe31531b0a7a4b491055e68f956ef48fe418230bed72a5d8f918deebc33016df464431b4bda05a279317ec17f23bef18a6051969ebd12253d1d8c313a3924efbeca315c1792bed44aab2c2b3ddf547ae162616b563c0c59ff79b106822a7f4ae4f2f61fface752f60fd9639d085a58ea5b6d352caef47d75effc727bb1986693afb968be8699132d4cf691d5afad74d412ee279f852bbe735ed309340cfa2ea92030ef82ccb4596bce0e75d959795b6c1dce24deec2a242de486a51075d3730d69b94d7782327dbb571c552300c31d6391cb43b79dc3813d14a51c4857abfc4b3fe1a690744a8a6a3dd983a91d1d253045c248fc9c41a14c2504bb4135a3de78f8d4464331502fe8da4cc170f473c5a896d7a199a189f941e29f098d556a6af29b7eacfa4f78d7ef7acd28b9b444030400008085202f89010000000000000000000000000000000000000000000000000000000000000000ffffffff0603e0fb300101ffffffff01f80bf605000000002321028b8f113379ab8156fb53ebb2d830e1e9a75b8554e0785621fa88d60addac3f7facf1f554670000000000000000000000000000000400008085202f8901a2825cddd2b4b7859cebd48e969409cdce904009f1a795b5b2d85cf8af4dc35100000000d74730440220082b8dfe0dd6f139999592709e869e79efb91b8b855decaa935c65d59dee84dc022074e5da1a91f3587395f43022bcdccb9830f3f18ba1b2949bed97be2abce1a7fe0120c5082d81992d4f281a0901ca13e5b00202e1acb322d00dcb2de5dbf4f62e8c7c004c6b630441675567b175210344bc9fcea4940cd2151cf49766de11625d9c8226c0f2cdb6c7d9167d922b4635ac6782012088a91492b5adcdfdb0e7c87ad262223cb422e0b5d0d94f88210343ec6d09f1653a6184ba47e368e16c2850d4c3e78c085280a0d5fc2880491668ac68ffffffff0041675567f3fb3000182ba36affffffff000189bd21c6f62f0cf1301ff7dfbcb38bf094b11d65254ec6eed4540fc0f1e2edc1944fcc6316ed377d0e92024577a9bbc2a8ecdcea22b47d3a556e58122128831b96278b5a9b9ec3fc47f2691c0e9ad02868eb03a5b3232ac8a9f487cd2ed65590b1c711c22f1246624a7dc067ade3d670ee62540bb7f3f75f0a7315adecfb483e4e136563cf4c58f815b694018be4786faa88000a3cf7139fa199ed194f7d7b7898b2416c1c4c5723ab2a570f85b5de840b3ca34587bd28d4a593e4ddcad399cb4af4ea982d19f916d66ef5887f754c03fadda76f61d47e02c81971e62a147d15ab927a5e3963b021596b4c39a5949cc0fd47968bb1fb9f25c2beac3c9a9470d08c5b2d57a970e4a5499f148e3001fdf5a213d2c975ff0f9f4541039d402539681f1c8e4f4ede51b00b6f678acd69483c85bf7f0e5ac900689faed091dcb0705035cd81890bfcb2a727cc2f4ee9a49b79e40fd51101d1fec06a43b4bb9b209a8d6a40be7aaa5ec02aad2b7a9f3497bbde4e94ecfcace3f0ad51665256ca179325ea9a5f94c712e9655ff5072386434263b3ea6b384752a1158a42ad106f353ebab378193e88ddb6e6e61e7e2b2210092a7b93af80d427ddf0e8a01272aaf7917d4bbd116858787cba5496aaaa0b2a6f3f037a8a36f49df22ddf9d6123e46eaff9a658145b66063e0f0bcc410746443a423c727372a4ceabdbf4af73ee2a50d173aba84576f64eb601fc1856113c68f48f55006f716ff1ebdd8c076b54dca59c5294f3bfbac5b1b30d8a294b7f2281acc61620a4c16424a53b1ad6847b911bdcc349b014a4f99acaca8f7a1f2dad0ab0d480130e5834778378fdd273964c3d1e447a35a3292bae1f5931062d9ec7cc0d4e790827fab3f22e8cb6ea6362a0f93bd43efdd34ae6ca41f56d43758cac278bb850ee8c101f80d951cfa68bfb893ce85cfa03359c1686ecbedfe9ec42567e54a93bbdd1d5960aae2d38f2851cd31e0f8f49b2f54175f2caf86be532682868f662c32bdcd3bc1d4de6d811ec69ae813ab829769bbc3d6f7a96079ea462e0cf318961624548a6889d2cc877cbc34955c92d7e8101ef75990d3e669acbdbad0a690408cda94ad998a8d083ad622e172d94f6ed6775ae818b25f281a6ef2bb0df2f420a05de645756b7f7a174d3fcd8623278f9982c6839ff8b4dd743d800025b8690048aef690414d497c9066e548d9c6c57122807f804d274e611265710582e1229b2dbeb72a7f9f90fd8a7c88eeaad852ba931e191adf640c3138059b05c0099f6d8e3d5a6c9d25fa724aa5ec0eae0596adfb863337bcf5d3ef1f9fb0a0bc374cf1feff57d004b0415bd094daf5e2ce229a067ea68b23a7f1c9a979ff8630755eaadf2f9d43ac1b8cc4de1222f2bc7df5958db1a7a315951c6a3d91ecf00ec165fdc55b248010400008085202f89000000000000a8fc3000102700000000000001d05597bddf5186ad6f2cdab459ad7ad34e3b0edf843b2232d088afe0d0fda32d6df49340400b5f56349d59be468d429f2eee23cef7199c7ede495ff6e5abfc11a3daba98b7f089426dddd73da8c31be6f421ad30e174a0666d3294cf62bae0e5534cd20f4cc7974f82e8a85b81b47b2accfb3d45fd1e7f6682835169797f4631a1d16c08875fbb29be29cfb851a113d18e88619f9b104d0df255f4c9ced377c063d40368b0ad623d4d9661bb0bd1c7e0b0b201c2b3eee7e4407dc5d003e3f563a0584c509110d30ef9b8fddb35d742f50b5bb28387699e9462af5fa6bbec477d017147ff2990590b0d6ee1d190e1bef76bef797ab024def2cfd7b7f435ea2fe9955289986e236a1e47258f414822fe8db3b79410c1e280ff0100864c885ee7bfc5ff43d3335900df7dea9d2f5658bcedf102ea9f1527dc84e160b3e138a68198b4cfeb0ccbc3360ca19ce32ee8a1ad97f53be9fce2ea910f81375f6ad08bed29c30ccab1428c6541356048f5a371c5d3549f1242a1b3279915edabd211e6240b01341148e35b65fde0a8fd6c4ce4a138b1bc111800a9f64119da7ba69516cdf1a10ea7d9e8c5ce457d72836b95654fd343ad369c14eb61bdd77ae36d78fdec5b4fc1a73a82947d1d9f99447c4c017ec291636895e7ce710e4862833dcb57b3ce4b5cb02c40fbb24008cb5c303a2baf50d195382ef5ba7e13bf27e9c271877fbf968602a33eec3b77cebf91bc4c074f1bfaedf7e3a277cfaf891223ab37a6b5d1082604a25cc344a842ab671c26d252af3a14f16ef00184476151dd12cbcca917f14e4590db9bfe3f4efeb856286455fe10450e92e5a5a3947a54e7afea45b646df05d907cd6ab6725b402470fead9ea0db8b5ab0812d65750f3fc9a537cddad0774b7401e75ae373722e8607b157e30d537c21d610127eb5c1cde4e0d0c94abdc96ab9a350f9ed4de99e7d64bc0fe5f77b8f44ccfe64620b70ef6790ccbf7d6a4385b2e9a772adf28614f9ad246cf8475c67b859420db23fa203f20597e3c88f414bcb8f8124ea8e170a1a089a3a9516c7fd3747bd5664a3f41f29da025eaa92ef2fc771f1421d260dd806e5ff8bd59c0b32c270ddef639d6bd1b2e47812c4c91398e53eed9dc644aaa193d965cf8aa76088eb074d1eb80e62c93605a3d76cbcc843d2c6a30d8eb0690cdd7818b021eb734e52424faf71eb2b6f3f03b9cc140d444f9909e5b5bb422ab08d94fef1630c41a7e8396b3825d79c380b6c08667628f12414514f2543cea5ec3fb594a6948fc436e75b15d6a1318a15bb567e742cac8763b94f4d67e4f76c5e647185f15cba5f89c66d1010709e497705f70b36792e18758d3fc57987aa8ae5268187749379cfcfc512794bf0583ebe16f0f5777f8fef980e77b27d75afeddd2a392d4b10e82a425e3b7b2ab31da1e944f13d0e04a1b2cbf36c37ee00553cac8608180af2e9773e18334b18cc3259615bd593ec9c853403181b7b6d3fc2cf879c92ac89ccb4968eea2290b62ff22c845564de183cabf68d2ea651424ac5c55971b1779a00aeb459e906af744bddf3094ce9744fe38e9a446afa88707c895d6523b7c4a7e5348b0b3550b192ac7bec1be755ed9fa593f41103677aed6bed7d597a2b630dcfae3efc190ef88eef7075ba1349478ba8c8dfea50fac793746bcba158a0282d57580097bd266c33f41edbda06e8c70e8d7b185350e25d2e83a9bc893f4af382011951513bed91022f31cde8a485bc38c049377495a91e1831a9cedeb8c4530e0bacb2aa539c1e311ba5133abd5ffb8b70b724b9d5468b84d834b93c07761484fcfbf63240dc533dd16ea95735bff2360b2ef58d3fe27aa3a6aabbe0f3bc94eee1ed230887199e007e4f24c37a1dd95ec6ed5ecde81c3adbbf7f511c68481f3bc73ff0ea72353bd71166958bd161807d1549bc1506b88354fb6adf6d1d6e5cf6654439ffa106b902
 */
	}
}

func getEmptyBlockData() []byte {
	//  pirate-cli getblock 000000017600b61191969793d2d61657ea099546ff3e0bff48dba601a33954ad 0
	hexData := 
		"last_notarized_height": 3210266,
		"hash": "000000017600b61191969793d2d61657ea099546ff3e0bff48dba601a33954ad",
		"confirmations": 50,
		"rawconfirmations": 50,
		"size": 1608,
		"height": 3210229,
		"version": 4,
		"merkleroot": "18041cad0c8839908ff543700d3060eaee436505708355b3b2f25bc8e9530531",
		"segid": -1,
		"finalsaplingroot": "170af3efbdc041548123896eefc034c89d42a0f08058b73a1480daa13af03503",
		"tx": [
		  "18041cad0c8839908ff543700d3060eaee436505708355b3b2f25bc8e9530531"
		],
		"time": 1733622086,
		"nonce": "76bf01a80000000000000000000500000000000000000000000000001477f85f",
		"solution": "01d13acb307c3507ff8f9764957a7a327e529c32390ec1015532544baeb2e077a6946c22f6f5fd9827e41045bcf2edb7aa15c727a3e469da43bed2beb6a7652dd2b3808e9fad4f0bcf35303badf6fe0cc23fb2e506468cf1645ef141d8c7f693536b223ed1ffd9d983444ce4ac0b6e7be9a4591457d82e8277764fff91a71ca88c701ca28021550ad633c7d3a6d63d76357bcb3a26da6e2ee98ead58d4480947f082e20f1f373551053a352c95876aad6de6721932350cb99b7c9c390110e16ff48acd973ece950163ba0f92311ffef4901a0b93afb350e93e4f9ed02222d3d219fddffe32a4c20deb1a1a87c5faec4ff1d5e4db4a434f0e805dfcdc1c77af3aa6676a09bb54b20af925cfac83fa159b841d62a32cb88de65775471263429c9fb5772d1156eb2f3351a21b12c44bdd01831fd225457f5abfdfc5a4340f5ee2f51ba40bdf3775dd95d84d59ad047771270687c10b55aeeeedf211d32225f07bc8f17e1d04a438b0dbba2e226381b285c66265f50479b326b4db3119329bfc2f31dc6bcd19c65a8fb7f49ab1e81f1aeb31f1eea6064d726b741a682eb27c19be6e287aa42307c51fed8c8c5cdca4b8957694d6822192d49b9c76192c212e5e981187dad79602b6f07f31ea993e04661167aad1295013f34c5204c0b0ee716ac7af1cc191265e4e62e85866ace068283bca483bd25d22ddb8dd095eed6e05520457e32905697938ecd2f8651c79b123a3b73ed094b420ec60024f29a9b7fd85f25765970c51936a9a67d54b6a8bc16372b96e2e66d313a5a13e769a216428249b8b89d75c063fae91f5117d4bc62426f34b33096649c5fcb50bc44f3cce1cf3957ff73f7eb2ca97156c31432d257333d190dbd3863ee91c3060fc7993f2cf9bcc81e4f254ca5071526eefcd6237ef0f899560a77da1a5643ab7dfd96e8ffdb518b40227502659114fc53850e167f89582390ac97f42911c466b769c4f024cb1f09392f07ca2616e3eebee450d9e29472c9434a540fe54e70859bc4951950ef7e1100f32bf915d99c30b2c3251a2abf3b0e68a587952047dfdaa8360557d2508c217de98a86a5104bd9edb4e9b6aab5ad454e7e67e07e5b361ef1dfbd17fe7d8055fa1611d66c0278b94c1c490b900420af2b85d061af252874255455534aac3c3d2cfc435121b139b900255d8202e06fc80aa94c1cb4cd35f8d240b79403c0afa5d640a8ed74319bf740ed3dc82e1a660136dd2192375769f273b71c884f2809fc7ae414d8d741512280dd7c8084f1ed76a130469c94de57a1ff97237010eabf2a494f29067a7d672122e6ec281916cee1b8b291f7ef0628fde87daa5c3abc2afcd59d14173a94710f90e61056826097dde08a9ecc8d9625eeedb758a601ea6e3c1f87081f27c58d57579e6c311e55e9d8c022763f3002e3c01adbb81982c27259d9c003194b82d14d27b3511c5afa169630c9a2614f677413ce14c063d6cf2089bf06d1698c0d838e51975a16572d01525cdfb11dae3bf698ae213512fc6b72e37661d0f62067e9b847a9c9587bdcbc7cc5273c8c60c18b7b6760b9b4e027ee7334197d6a0fa3ddeef748e2e533d930f75a4a3be137e3db380c4682d38123a87f9f64a761d4904012bc8338875949262c9abc21dd4031fa66c05c583058c710ce5b8694131862c0b384ef086e7cb16b84e0585ffa8e7fe56634a1d5b885a671ddebcef49fa76a1a6aacc1de92e36409a4d1eaa7bce9e17a553555a9e0499a0d5478e85e7954a350e6497fab863097f0b76bb4d8adb720ca567083fb70db424adb0d42f75eaf1ada0e6d53e1014b66a7f6af9fc77348fe52de744cf7ed4ff3107b7f32ed023ca9573b13a43a937bcfb0509983e4552da9b0c5059c3af2338dc94c0",
		"bits": "1d01b9d8",
		"difficulty": 146380141.6677276,
		"chainwork": "00000000000000000000000000000000000000000000000000d0db20d5371e3e",
		"anchor": "666dece9764c9b2b41fadea44086d3323633845d811e3e61bd829caebef7651e",
		"chainSupply": {
		  "monitored": true,
		  "chainValue": 198428749.75684738,
		  "chainValueZat": 19842874975684738,
		  "valueDelta": 1.00000000,
		  "valueDeltaZat": 100000000
		},
		"valuePools": [
		  {
			"id": "transparent",
			"monitored": true,
			"chainValue": 181178.70448083,
			"chainValueZat": 18117870448083,
			"valueDelta": 1.00000000,
			"valueDeltaZat": 100000000
		  },
		  {
			"id": "sprout",
			"monitored": true,
			"chainValue": 1294335.32384994,
			"chainValueZat": 129433532384994,
			"valueDelta": 0.00000000,
			"valueDeltaZat": 0
		  },
		  {
			"id": "sapling",
			"monitored": true,
			"chainValue": 196953235.72851661,
			"chainValueZat": 19695323572851661,
			"valueDelta": 0.00000000,
			"valueDeltaZat": 0
		  },
		  {
			"id": "burned",
			"monitored": true,
			"chainValue": 0.00000000,
			"chainValueZat": 0,
			"valueDelta": 0.00000000,
			"valueDeltaZat": 0
		  }
		],
		"previousblockhash": "00000000857b8564e53b6c2c6dd20620566610c05b909e0c2fc977437ae0f005",
		"nextblockhash": "0000000107811ce9453769e1ed03a32901286f8c8b8443d215d2a31638a8c68d"
	  

	// Decode the hex string into a byte slice
	data, err := hex.DecodeString(hexData)
	if err != nil {
		log.Fatalf("Failed to decode hex string: %v", err)
	}
	return data
}

func getCorruptBlockData() []byte {
	// Mock corrupt block data
	return []byte{
		/* 0400000098ed096437560c6f1g1d228c279a6c316b705e8abdff1ba9ad3808930000000013752f2e5e998b6c0b6853fe2413b216aa15406c42e560ba8e9222r1d73b0a834f0bad5158b983d581f2b256aacf47af79379ea6f2632e5e5e314b1a5ec3aa6bf1f5546756b6011d3fffabee00000000000000000000000000002d0000000000000000008018e53afd40050099fe94531276bcc85650b264bd49f1c0db330b4a2240824c2434ed5dc30468f37ffd86f6521f53fe5d3a11bb774b5a2367f810b65d8bfc9eaa1ad9f6f3174170edb08b52b4ff1cfb46201154ec32bdc4beb67d08b81cf157eca1699633a27235eb9b1257551f916c381a7f2d91a3f57f6ba88d41a0fff7a7941e7ea57511ce639cb187c5d4cf20baf87b5fcd72cd671defef342c82a33d5a2b2135b707aefac7457f479f9b2868034cbb3577854bbf2555e1ed2de71da8fcb80b87d11af6dad7dd8c7b36dc475abaf9ee5b8b10b01e2fb60cc1e4f6fe52245f744fb20c7e62f2ea6d0a93fa00235459bfead94692d25c7261fc72a538a171ddd89311e2f0bf21a2f1fbff59024b1abf5dd69ad8f82aa53e9d7a99cab110bdb5daf54174481e1662aab5684812b49c1f31286365d64d213178350712325df41cf951a13d018e211b21b79095d32163c38daa46d785e400d5362a1353daf73b3443b1ce7c0981483677d52b2fcfe1d27cddb76b515833d1452afe4d57b431433e0150cd267b1745aac469a02832e7612016c95db2190c3ec38c7365dcab3cd11282d8d9dd6a774ab4a86207febd11ef048b659780336e3b5a8e2aa2391f80d12dfd5326fa5e9291d09f92ffd57e4a5d2656d0e8cc538ba3f5859b1b6ffd024752d8f21dc9d716bf296f6f9965c1e99fbd6f831cc7423cdb34773902dc1aa604012a15a7c8a4d9290b0360387f56f562d5fe3a5f0ba876e558ec655ffb3c884a56caf49e2e44577997210fbb3017ccb445b5f7431c95f2986b260fdd335526ace66fddcb09332dd102e6c0e1139b635f7caba10895d862a446fef5719172b890c15af648a0b54e5215ddf590eba09735902a24e1306baa9d958df0be6c12bdb3a995df497b2f507362e91ec4ddd26798e56e1f168b6c6a92b5c1ede74387f467c1150eeb145e6c0140bbc39f6eb7597971a074a32c3110e9c9a88eab0e274b6c8e978e935936656f343fd6ba4d75d5a59d0256464fa27424b5d69e8074dae440284161393de60408d1c37d8636cd06d9d2311adb47994fdcd6116109d56dfc4873c41db0a150e24ee248e14e0a37086d3238dde4af944ff8d558a9378f6f6f5e548ab7100512c60ac611679419b8b5d2ad80de59f620ef51113f346e83944d4f92992fd8b39685315a81993a14210106f4a308e6533685910ba870387586b62e289861324839646acff6010dc5ad37931e4878634b86fbd6b11dd8d7a61cd82e38e2ee5a8315da3f86a6ab5d3a063ca6cd2cda24e901912aa40a487e2bea5f5d5c4cf707c2871ac9462fef14d0b15c97e5fcf8f2f34d7a5117ac338a290933331666a57d7e6508d65a13de30b215238ab0378583bb1fab317664e47cbd55339de6bf24a152802962fb1180b88534a1df764e4f823a4d2009c4c75faa1b6cf583321139675520555ed89bd6020bac5dd632c62ec9029bb3fc8ffe31531b0a7a4b491055e68f956ef48fe418230bed72a5d8f918deebc33016df464431b4bda05a279317ec17f23bef18a6051969ebd12253d1d8c313a3924efbeca315c1792bed44aab2c2b3ddf547ae162616b563c0c59ff79b106822a7f4ae4f2f61fface752f60fd9639d085a58ea5b6d352caef47d75effc727bb1986693afb968be8699132d4cf691d5afad74d412ee279f852bbe735ed309340cfa2ea92030ef82ccb4596bce0e75d959795b6c1dce24deec2a242de486a51075d3730d69b94d7782327dbb571c552300c31d6391cb43b79dc3813d14a51c4857abfc4b3fe1a690744a8a6a3dd983a91d1d253045c248fc9c41a14c2504bb4135a3de78f8d4464331502fe8da4cc170f473c5a896d7a199a189f941e29f098d556a6af29b7eacfa4f78d7ef7acd28b9b444030400008085202f89010000000000000000000000000000000000000000000000000000000000000000ffffffff0603e0fb300101ffffffff01f80bf605000000002321028b8f113379ab8156fb53ebb2d830e1e9a75b8554e0785621fa88d60addac3f7facf1f554670000000000000000000000000000000400008085202f8901a2825cddd2b4b7859cebd48e969409cdce904009f1a795b5b2d85cf8af4dc35100000000d74730440220082b8dfe0dd6f139999592709e869e79efb91b8b855decaa935c65d59dee84dc022074e5da1a91f3587395f43022bcdccb9830f3f18ba1b2949bed97be2abce1a7fe0120c5082d81992d4f281a0901ca13e5b00202e1acb322d00dcb2de5dbf4f62e8c7c004c6b630441675567b175210344bc9fcea4940cd2151cf49766de11625d9c8226c0f2cdb6c7d9167d922b4635ac6782012088a91492b5adcdfdb0e7c87ad262223cb422e0b5d0d94f88210343ec6d09f1653a6184ba47e368e16c2850d4c3e78c085280a0d5fc2880491668ac68ffffffff0041675567f3fb3000182ba36affffffff000189bd21c6f62f0cf1301ff7dfbcb38bf094b11d65254ec6eed4540fc0f1e2edc1944fcc6316ed377d0e92024577a9bbc2a8ecdcea22b47d3a556e58122128831b96278b5a9b9ec3fc47f2691c0e9ad02868eb03a5b3232ac8a9f487cd2ed65590b1c711c22f1246624a7dc067ade3d670ee62540bb7f3f75f0a7315adecfb483e4e136563cf4c58f815b694018be4786faa88000a3cf7139fa199ed194f7d7b7898b2416c1c4c5723ab2a570f85b5de840b3ca34587bd28d4a593e4ddcad399cb4af4ea982d19f916d66ef5887f754c03fadda76f61d47e02c81971e62a147d15ab927a5e3963b021596b4c39a5949cc0fd47968bb1fb9f25c2beac3c9a9470d08c5b2d57a970e4a5499f148e3001fdf5a213d2c975ff0f9f4541039d402539681f1c8e4f4ede51b00b6f678acd69483c85bf7f0e5ac900689faed091dcb0705035cd81890bfcb2a727cc2f4ee9a49b79e40fd51101d1fec06a43b4bb9b209a8d6a40be7aaa5ec02aad2b7a9f3497bbde4e94ecfcace3f0ad51665256ca179325ea9a5f94c712e9655ff5072386434263b3ea6b384752a1158a42ad106f353ebab378193e88ddb6e6e61e7e2b2210092a7b93af80d427ddf0e8a01272aaf7917d4bbd116858787cba5496aaaa0b2a6f3f037a8a36f49df22ddf9d6123e46eaff9a658145b66063e0f0bcc410746443a423c727372a4ceabdbf4af73ee2a50d173aba84576f64eb601fc1856113c68f48f55006f716ff1ebdd8c076b54dca59c5294f3bfbac5b1b30d8a294b7f2281acc61620a4c16424a53b1ad6847b911bdcc349b014a4f99acaca8f7a1f2dad0ab0d480130e5834778378fdd273964c3d1e447a35a3292bae1f5931062d9ec7cc0d4e790827fab3f22e8cb6ea6362a0f93bd43efdd34ae6ca41f56d43758cac278bb850ee8c101f80d951cfa68bfb893ce85cfa03359c1686ecbedfe9ec42567e54a93bbdd1d5960aae2d38f2851cd31e0f8f49b2f54175f2caf86be532682868f662c32bdcd3bc1d4de6d811ec69ae813ab829769bbc3d6f7a96079ea462e0cf318961624548a6889d2cc877cbc34955c92d7e8101ef75990d3e669acbdbad0a690408cda94ad998a8d083ad622e172d94f6ed6775ae818b25f281a6ef2bb0df2f420a05de645756b7f7a174d3fcd8623278f9982c6839ff8b4dd743d800025b8690048aef690414d497c9066e548d9c6c57122807f804d274e611265710582e1229b2dbeb72a7f9f90fd8a7c88eeaad852ba931e191adf640c3138059b05c0099f6d8e3d5a6c9d25fa724aa5ec0eae0596adfb863337bcf5d3ef1f9fb0a0bc374cf1feff57d004b0415bd094daf5e2ce229a067ea68b23a7f1c9a979ff8630755eaadf2f9d43ac1b8cc4de1222f2bc7df5958db1a7a315951c6a3d91ecf00ec165fdc55b248010400008085202f89000000000000a8fc3000102700000000000001d05597bddf5186ad6f2cdab459ad7ad34e3b0edf843b2232d088afe0d0fda32d6df49340400b5f56349d59be468d429f2eee23cef7199c7ede495ff6e5abfc11a3daba98b7f089426dddd73da8c31be6f421ad30e174a0666d3294cf62bae0e5534cd20f4cc7974f82e8a85b81b47b2accfb3d45fd1e7f6682835169797f4631a1d16c08875fbb29be29cfb851a113d18e88619f9b104d0df255f4c9ced377c063d40368b0ad623d4d9661bb0bd1c7e0b0b201c2b3eee7e4407dc5d003e3f563a0584c509110d30ef9b8fddb35d742f50b5bb28387699e9462af5fa6bbec477d017147ff2990590b0d6ee1d190e1bef76bef797ab024def2cfd7b7f435ea2fe9955289986e236a1e47258f414822fe8db3b79410c1e280ff0100864c885ee7bfc5ff43d3335900df7dea9d2f5658bcedf102ea9f1527dc84e160b3e138a68198b4cfeb0ccbc3360ca19ce32ee8a1ad97f53be9fce2ea910f81375f6ad08bed29c30ccab1428c6541356048f5a371c5d3549f1242a1b3279915edabd211e6240b01341148e35b65fde0a8fd6c4ce4a138b1bc111800a9f64119da7ba69516cdf1a10ea7d9e8c5ce457d72836b95654fd343ad369c14eb61bdd77ae36d78fdec5b4fc1a73a82947d1d9f99447c4c017ec291636895e7ce710e4862833dcb57b3ce4b5cb02c40fbb24008cb5c303a2baf50d195382ef5ba7e13bf27e9c271877fbf968602a33eec3b77cebf91bc4c074f1bfaedf7e3a277cfaf891223ab37a6b5d1082604a25cc344a842ab671c26d252af3a14f16ef00184476151dd12cbcca917f14e4590db9bfe3f4efeb856286455fe10450e92e5a5a3947a54e7afea45b646df05d907cd6ab6725b402470fead9ea0db8b5ab0812d65750f3fc9a537cddad0774b7401e75ae373722e8607b157e30d537c21d610127eb5c1cde4e0d0c94abdc96ab9a350f9ed4de99e7d64bc0fe5f77b8f44ccfe64620b70ef6790ccbf7d6a4385b2e9a772adf28614f9ad246cf8475c67b859420db23fa203f20597e3c88f414bcb8f8124ea8e170a1a089a3a9516c7fd3747bd5664a3f41f29da025eaa92ef2fc771f1421d260dd806e5ff8bd59c0b32c270ddef639d6bd1b2e47812c4c91398e53eed9dc644aaa193d965cf8aa76088eb074d1eb80e62c93605a3d76cbcc843d2c6a30d8eb0690cdd7818b021eb734e52424faf71eb2b6f3f03b9cc140d444f9909e5b5bb422ab08d94fef1630c41a7e8396b3825d79c380b6c08667628f12414514f2543cea5ec3fb594a6948fc436e75b15d6a1318a15bb567e742cac8763b94f4d67e4f76c5e647185f15cba5f89c66d1010709e497705f70b36792e18758d3fc57987aa8ae5268187749379cfcfc512794bf0583ebe16f0f5777f8fef980e77b27d75afeddd2a392d4b10e82a425e3b7b2ab31da1e944f13d0e04a1b2cbf36c37ee00553cac8608180af2e9773e18334b18cc3259615bd593ec9c853403181b7b6d3fc2cf879c92ac89ccb4968eea2290b62ff22c845564de183cabf68d2ea651424ac5c55971b1779a00aeb459e906af744bddf3094ce9744fe38e9a446afa88707c895d6523b7c4a7e5348b0b3550b192ac7bec1be755ed9fa593f41103677aed6bed7d597a2b630dcfae3efc190ef88eef7075ba1349478ba8c8dfea50fac793746bcba158a0282d57580097bd266c33f41edbda06e8c70e8d7b185350e25d2e83a9bc893f4af382011951513bed91022f31cde8a485bc38c049377495a91e1831a9cedeb8c4530e0bacb2aa539c1e311ba5133abd5ffb8b70b724b9d5468b84d834b93c07761484fcfbf63240dc533dd16ea95735bff2360b2ef58d3fe27aa3a6aabbe0f3bc94eee1ed230887199e007e4f24c37a1dd95ec6ed5ecde81c3adbbf7f511c68481f3bc73ff0ea72353bd71166958bd161807d1549bc1506b88354fb6adf6d1d6e5cf6654439ffa106b902
 */
	}
}

func TestParseFromSliceWithMerkleFrontier(t *testing.T) {
	// Case 1: Valid block with multiple transactions
	block := NewBlock()
	data := getValidBlockData() // Mock valid block data
	_, err := block.ParseFromSlice(data)
	assert.NoError(t, err, "Parsing a valid block should not produce an error")
	assert.NotNil(t, block.MerkleFrontier, "MerkleFrontier should be initialized")
	assert.NotEmpty(t, block.MerkleFrontier.GetRoot(), "Merkle root should not be empty for valid block")

	// Case 2: Empty block
	block = NewBlock()
	data = getEmptyBlockData() // Mock empty block data
	_, err = block.ParseFromSlice(data)
	assert.NoError(t, err, "Parsing an empty block should not produce an error")
	assert.Empty(t, block.MerkleFrontier.GetRoot(), "Merkle root should be empty for an empty block")

	// Case 3: Invalid block with corrupt transaction
	block = NewBlock()
	data = getCorruptBlockData() // Mock corrupt block data
	_, err = block.ParseFromSlice(data)
	assert.Error(t, err, "Parsing a block with corrupt transaction should produce an error")
}

func TestMerkleFrontierQueries(t *testing.T) {
	// Mock a block with multiple transactions
	block := NewBlock()
	data := getValidBlockData() // Mock valid block data
	_, err := block.ParseFromSlice(data)
	assert.NoError(t, err)

	// Case 1: Generate Merkle root
	root, err := block.GetMerkleRoot()
	assert.NoError(t, err, "Getting Merkle root should not produce an error")
	assert.NotEmpty(t, root, "Merkle root should not be empty")

	// Case 2: Generate proof for valid transaction index
	proof, err := block.MerkleFrontier.GenerateProof(0) // Proof for first transaction
	assert.NoError(t, err, "Generating proof for valid transaction should not produce an error")
	assert.NotNil(t, proof, "Proof should not be nil")

	// Case 3: Generate proof for invalid transaction index
	proof, err = block.MerkleFrontier.GenerateProof(999) // Out-of-bounds index
	assert.Error(t, err, "Generating proof for invalid index should produce an error")
	assert.Nil(t, proof, "Proof for invalid index should be nil")
}
